___
# âœ 20211115 TIL

<br/>

> ## âœ¨ Issue
> - X
> 
> ## â˜• íšŒê³ 
> - ì¸ì¦ ì²˜ë¦¬ ê³¼ì •ì„ ìì„¸íˆ íŒŒì•…í•˜ê³  ìˆì–´ì•¼ê² ë‹¤!
> - Spring Securityì˜ ë¡œì§ì„ ì‚´í´ë³´ë‹ˆ ê°ì²´ ì§€í–¥ì ì¸ í”„ë¡œê·¸ë˜ë°ì„ ë” ì´í•´í•  ìˆ˜ ìˆê²Œ ë˜ëŠ”ê²ƒ ê°™ë‹¤.  
> ë§Œë“  ì‚¬ëŒ ëŒ€ë‹¨í•˜ë‹¤... ğŸ‘

<br/>

## Thread Per Request ëª¨ë¸, ThreadLocal
- `Thread Per Request ëª¨ë¸`
  - WASëŠ” ThreadPoolì„ ìƒì„± (Tomcat ê¸°ë³¸ê°’ 200)
  - HTTP ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ Queueì— ì ì¬ë˜ê³ , ThreadPool ë‚´ì˜ íŠ¹ì • Threadê°€ Queueì—ì„œ ìš”ì²­ì„ ê°€ì ¸ì™€ ì²˜ë¦¬
  - HTTP ìš”ì²­ì€ ì²˜ìŒë¶€í„° ëê¹Œì§€ ë™ì¼í•œ Threadì—ì„œ ì²˜ë¦¬ë¨
  - HTTP ìš”ì²­ ì²˜ë¦¬ê°€ ëë‚˜ë©´ ThreadëŠ” ë‹¤ì‹œ ThreadPoolì— ë°˜ë‚©ë¨  
    ì¦‰, WASì˜ ìµœëŒ€ ë™ì‹œ ì²˜ë¦¬ HTTP ìš”ì²­ì˜ ê°¯ìˆ˜ëŠ” ThreadPoolì˜ ê°¯ìˆ˜ì™€ ê°™ìŒ
  - Thread ê°¯ìˆ˜ë¥¼ ëŠ˜ë¦¬ë©´ ë™ì‹œ ì²˜ë¦¬ ê°¯ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ì§€ë§Œ, Thread Context ìŠ¤ìœ„ì¹­ì— ì˜í•œ ì˜¤ë²„í—¤ë“œë„ ì»¤ì§€ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ì„ í˜•ì ìœ¼ë¡œ ì¦ê°€í•˜ì§€ëŠ” ì•ŠìŒ  
    <img width="600px" src="https://iyboklee.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F594f8357-da17-4ca1-86d8-01a70ca0308e%2F3_1.png?table=block&id=fcab2886-8683-4c53-aa6f-4df0baea5041&spaceId=e1875985-78ea-4757-91b0-baa29d833ec6&width=1630&userId=&cache=v2">
  - WebFluxë„ Thread ê°¯ìˆ˜ë¥¼ ì‘ì€ ê°¯ìˆ˜ë¡œ ìœ ì§€í•˜ë©° HTTP ìš”ì²­ì„ ë™ì‹œ ì²˜ë¦¬ í•  ìˆ˜ ìˆë„ë¡ í•¨
    - HTTP ìš”ì²­ì€ í•˜ë‚˜ ì´ìƒì˜ Threadì— ë°”ì¸ë”©ë˜ì–´ ì²˜ë¦¬ë  ìˆ˜ ìˆìŒ
- `ThreadLocal`
  - Thread ë‚´ë¶€ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì§€ì—­ë³€ìˆ˜
  - ì˜ˆì‹œ
  ```java
  // ThreadLocal ë³€ìˆ˜ ìƒì„±
  ThreadLocal<Integer> threadLocalValue = new ThreadLocal<>();
  // ThreadLocal ë³€ìˆ˜ì— ê°’ ì“°ê¸°
  threadLocalValue.set(1);
  // ThreadLocal ë³€ìˆ˜ì—ì„œ ê°’ ì½ê¸°
  Integer result = threadLocalValue.get();
  // ThreadLocal ë³€ìˆ˜ ê°’ ì œê±°
  threadLocal.remove();
  ```
  - ë™ì¼ Thread ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” Controller, Service, Repository, ë„ë©”ì¸ ëª¨ë¸ ì–´ë””ì—ì„œë“  ëª…ì‹œì ì¸ íŒŒë¼ë¯¸í„° ì „ë‹¬ì´ í•„ìš”ì—†ì´ ThreadLocal ë³€ìˆ˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ
  - Threadê°€ ThreadPoolì— ë°˜í™˜ë˜ê¸°ì „ì— ThreadLocal ë³€ìˆ˜ ê°’ì„ ë°˜ë“œì‹œ ì œê±°í•´ì•¼í•¨
    - Threadì— ì´ì „ ìš”ì²­ ì²˜ë¦¬ì— ì‚¬ìš©ëœ ThreadLocal ë³€ìˆ˜ê°€ ë‚¨ì•„ìˆê³ , ì´ë¥¼ ì°¸ì¡°í•˜ë©´ ì˜ëª»ëœ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŒ.

<br/>

## SecurityContextHolder, SecurityContext, Authentication
- `Security Context Holder`
  - Security Context ë°ì´í„°ë¥¼ ì“°ê±°ë‚˜ ì½ì„ ìˆ˜ ìˆëŠ” APIë¥¼ ì œê³µ
  - ê¸°ë³¸ êµ¬í˜„ì€ ThreadLocal ì´ìš© -> Thread Per Request ëª¨ë¸
  - `FilterChainProxy` finally ë¸”ë¡ì—ì„œ SecurityContextHolder.clearContext() ë©”ì†Œë“œ í˜¸ì¶œ  
    -> Threadê°€ ThreadPoolì— ë°˜í™˜ë˜ê¸°ì „ì— ThreadLocal ë³€ìˆ˜ ê°’ ì œê±°
- `Security Context`
  - Security Context Holder í´ë˜ìŠ¤ë¥¼ í†µí•´ ì½”ë“œ ì–´ëŠ ë¶€ë¶„ì—ì„œë“  Security Contextì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ
    ```java
    SecurityContext context = SecurityContextHolder.getContext();
    // ìƒëµ
    SecurityContextHolder.setContext(context);
    ```
  - Security Context ìì²´ëŠ” ì–´ë–¤ íŠ¹ë³„í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ ì•ŠìŒ
    ```java
    public interface SecurityContext extends Serializable {

        Authentication getAuthentication();

        void setAuthentication(Authentication authentication);
    }
    ```
- `Authentication`
  - ì‚¬ìš©ìë¥¼ í‘œí˜„í•˜ëŠ” ì¸ì¦ í† í° ì¸í„°í˜ì´ìŠ¤
  - ì¸ì¦ì£¼ì²´ë¥¼ í‘œí˜„í•˜ëŠ” Principal, ì‚¬ìš©ìì˜ ê¶Œí•œì„ ì˜ë¯¸í•˜ëŠ” GrantedAuthority ëª©ë¡ í¬í•¨
    - `Anonymous Authentication Token` í´ë˜ìŠ¤ëŠ” ìµëª… ì‚¬ìš©ìë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•œ Authentication ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´
    - `Username Password Authentication Token` í´ë˜ìŠ¤ëŠ” ë¡œê·¸ì¸ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ê¸°ë°˜ Authentication ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´
    - `Remember Me Authentication Token` í´ë˜ìŠ¤ëŠ” Remember Me ê¸°ë°˜ Authentication ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´
  - ì¸ì¦ì´ ì™„ë£Œë˜ê±°ë‚˜ í˜¹ì€ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìë¥¼ ëª¨ë‘ë¥¼ í¬ê´„ì ìœ¼ë¡œ í‘œí˜„í•˜ë©°, ì¸ì¦ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ
    - ì‚¬ìš©ìì˜ ì¸ì¦ ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¼ Principal ê°’ì´ ë‹¬ë¼ì§
      - ë¡œê·¸ì¸ ì „ Principal - ë¡œê·¸ì¸ ì•„ì´ë”” (String)
      - ë¡œê·¸ì¸ í›„ Principal - org.springframework.security.core.userdetails.User ê°ì²´
    <br/>
    <img width="600px" src="https://iyboklee.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fcba8955b-2518-4594-b64b-85f33d4ac480%2F3_2.png?table=block&id=185b5c3e-f047-4f97-b68d-b1f168198f92&spaceId=e1875985-78ea-4757-91b0-baa29d833ec6&width=1540&userId=&cache=v2">
<br/>

## ì¸ì¦ ì²˜ë¦¬ ê³¼ì •
<img width="1000px" src="https://iyboklee.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F82b8dc7e-ff83-42a2-8e37-a4409c6d414d%2F3_3.png?table=block&id=a25e6ea9-f159-44b9-a705-10192d610b74&spaceId=e1875985-78ea-4757-91b0-baa29d833ec6&width=2000&userId=&cache=v2">

### 1. `Default Login Page Generating Filter`
- Login í˜ì´ì§€ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µ
  - id, password, remember-me ê¸°ëŠ¥
  - ì»¤ìŠ¤í…€ êµ¬í˜„ ê°€ëŠ¥, ì»¤ìŠ¤í…€ ì‹œ í•´ë‹¹ í•„í„° ë¹„í™œì„±í™”
    ```java
    http
      // ìƒëµ
      .formLogin()
        .defaultSuccessUrl("/")
        .loginPage("/mylogin")
        .usernameParameter("my-username")
        .passwordParameter("my-password")
        .permitAll()
        .and()
      .rememberMe()
        .rememberMeParameter("remember-me")
        // ìƒëµ
      // ìƒëµ
    ```
### 2. User Login Request
### 3. `Authentication Processing Filter`
- ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í•„í„°
  - ëŒ€í‘œì ì¸ êµ¬í˜„ì²´: `Username Password Authentication Filter`
- ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•œ ì •ë³´ ì·¨í•©, ì¸ì¦ ì „ `Authentication` ê°ì²´ ìƒì„±
  - `Authentication` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ ì¤‘ í•˜ë‚˜ì¸ `Username Password Authentication Token` ê°ì²´ ìƒì„±
- ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì€ `Authentication` ê°ì²´ëŠ” `Authentication Manager`ë¡œ ì „ë‹¬
- ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ìƒˆë¡­ê²Œ ë§Œë“¤ì–´ì§„ `Authentication` ê°ì²´ ë°˜í™˜
  - `Authentication` ê°ì²´ëŠ” ì¸ì¦ì´ ì™„ë£Œëœ ìƒíƒœì™€ GrantedAuthority ëª©ë¡ì„ í¬í•¨
```java
@Override
public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
  if (this.postOnly && !request.getMethod().equals("POST")) {
    throw new AuthenticationServiceException("Authentication method not supported: " + request.getMethod());
  }
  String username = obtainUsername(request);
  username = (username != null) ? username : "";
  username = username.trim();
  String password = obtainPassword(request);
  password = (password != null) ? password : "";
  UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
  // Allow subclasses to set the "details" property
  setDetails(request, authRequest);
  return this.getAuthenticationManager().authenticate(authRequest);
}
```
- `Username Password Authentication Filter` ì¸ì¦ íë¦„
  
  <img width="500px" src="https://iyboklee.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9e4ed28b-1d60-4f9d-81fe-7d6bf6a9fb27%2F55.png?table=block&id=233ed2b3-8e12-485a-8009-b296064499e9&spaceId=e1875985-78ea-4757-91b0-baa29d833ec6&width=1630&userId=&cache=v2">
### 4. `Authentication Manager`
- ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•œ API ì œê³µ
  ```java
  public interface AuthenticationManager {

      Authentication authenticate(Authentication authentication) throws AuthenticationException;
  }
  ```
### 5. `Authentication Provider`
- `Authentication Provider` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ê°€ ì‹¤ì œ ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ê²Œ ë¨
  ```java
  public interface AuthenticationProvider {

      Authentication authenticate(Authentication authentication) throws AuthenticationException;

      boolean supports(Class<?> authentication);
  }
  ```
### 6. `Provider Manager`
- `Provider Manager`ëŠ” `Authentication Manager` ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´
- `Provider Manager`ëŠ” 1ê°œ ì´ìƒì˜ `Authentication Provider` êµ¬í˜„ì²´ë¥¼ Listë¡œ ë‹´ì•„ ê°€ì§€ê³  ìˆìŒ
- ì–´ë–¤ `Authentication Provider`ê°€ ì‹¤ì œ ì¸ì¦ì„ ì²˜ë¦¬í• ì§€ ê²°ì •í•  ìˆ˜ ìˆìŒ
  - ì£¼ì–´ì§„ `Authentication` ê°ì²´ì— ëŒ€í•´ supports(Class<?> authentication) ë©”ì†Œë“œê°€ trueë¥¼ ë°˜í™˜í•˜ëŠ” `Authentication Provider` ê°ì²´ê°€ ì¸ì¦ì„ ì²˜ë¦¬í•¨
  ```java
  public class ProviderManager implements AuthenticationManager, MessageSourceAware, InitializingBean {

    private List<AuthenticationProvider> providers = Collections.emptyList();
    // ìƒëµ
    
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
      // ìƒëµ
      for (AuthenticationProvider provider : getProviders()) {
        if (!provider.supports(toTest)) {
          continue;
        }
        if (logger.isTraceEnabled()) {
          logger.trace(LogMessage.format("Authenticating request with %s (%d/%d)",
              provider.getClass().getSimpleName(), ++currentPosition, size));
        }
        try {
          result = provider.authenticate(authentication);
          if (result != null) {
            copyDetails(authentication, result);
            break;
          }
        }
        catch (AccountStatusException | InternalAuthenticationServiceException ex) {
          prepareException(ex, authentication);
          // SEC-546: Avoid polling additional providers if auth failure is due to
          // invalid account status
          throw ex;
        }
        catch (AuthenticationException ex) {
          lastException = ex;
        }
      }
      // ìƒëµ
    }
    // ìƒëµ
  }
  ```
### 7. ì¸ì¦ëœ `Authentication` ê°ì²´ ìƒì„±
- ì¸ì¦ì´ ì™„ë£Œëœ `Authentication Token`ì„ ìƒì„±í•˜ì—¬ ë°˜í™˜í•œë‹¤.
```java
public UsernamePasswordAuthenticationToken(Object principal,
                                           Object credentials,
                                           Collection<? extends GrantedAuthority> authorities) {
    super(authorities);             // ê¶Œí•œ Collection
    this.principal = principal;     // User ê°ì²´
    this.credentials = credentials; // password
    super.setAuthenticated(true);   // ì¸ì¦ true
}
```
<details>
<summary>[ì°¸ê³ ] ì¸ì¦ ì „ Authentication ê°ì²´</summary>
<div>

```java
public UsernamePasswordAuthenticationToken(Object principal,
                                           Object credentials) {
    super(null);                    // ê¶Œí•œ ì—†ìŒ
    this.principal = principal;     // username (String type)
    this.credentials = credentials; // password
    setAuthenticated(false);        // ì¸ì¦ false
}
```
</div>
</details>
<br/>

___